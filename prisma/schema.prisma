generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String        @id @default(uuid())
  email        String        @unique
  name         String
  password     String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  products     Product[]     @relation("ProductCreator")
  transactions Transaction[] @relation("TransactionCreator")
  userRoles    UserRole[]
  warehouses   Warehouse[]   @relation("WarehouseManagers")
}

model Product {
  id               String                     @id @default(uuid())
  name             String
  description      String?
  sku              String?                    // Optional now, can be generated or set per variant
  price            Float                      // Price for the main product if no variants
  cost             Float?                     // Cost for the main product if no variants
  minStockLevel    Int                        @default(0)
  weight           Float?                     // Weight for the main product if no variants
  weightUnit       String?                    // e.g., 'g', 'kg'
  packageLength    Float?                     // Package dimensions
  packageWidth     Float? 
  packageHeight    Float?
  isPreorder       Boolean                    @default(false)
  preorderDays     Int?
  purchaseLimit    Int?                       // Max quantity per purchase
  hasVariants      Boolean                    @default(false)
  mainImage        String?                    // URL to main product image
  createdAt        DateTime                   @default(now())
  updatedAt        DateTime                   @updatedAt
  createdById      String
  categoryId       String?
  
  inventories      Inventory[]
  category         Category?                  @relation(fields: [categoryId], references: [id])
  createdBy        User                       @relation("ProductCreator", fields: [createdById], references: [id])
  transactionItems TransactionItem[]
  variants         ProductVariant[]           // Relation to product variants
  images           ProductImage[]             // Relation to additional product images
  variantCombos    ProductVariantCombination[] // Relation to variant combinations
}

model ProductVariant {
  id          String                @id @default(uuid())
  name        String                // e.g., "Color", "Size"
  productId   String
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt
  
  product     Product               @relation(fields: [productId], references: [id], onDelete: Cascade)
  options     ProductVariantOption[] // Relation to variant options
}

model ProductVariantOption {
  id          String         @id @default(uuid())
  value       String         // e.g., "Red", "Blue", "S", "M"
  image       String?        // Optional image URL for this option
  variantId   String
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  
  variant     ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
}

model ProductVariantCombination {
  id          String  @id @default(uuid())
  productId   String
  combinationId String // Unique identifier for this combination (e.g., "option1-option2")
  options     Json    // Stored as JSON: { "Color": "Red", "Size": "M" }
  price       Float
  quantity    Int
  sku         String?
  weight      Float?
  weightUnit  String? // e.g., 'g', 'kg'
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  product     Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  @@unique([productId, combinationId])

  transactionItems TransactionItem[] // Relasi balik ke TransactionItem
}

model ProductImage {
  id          String   @id @default(uuid())
  url         String   // URL to the image
  productId   String
  isMain      Boolean  @default(false)
  position    Int      @default(0) // For ordering images
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model Category {
  id          String    @id @default(uuid())
  name        String    @unique
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  products    Product[]
  materials   Material[]
}

model Warehouse {
  id             String        @id @default(uuid())
  name           String
  location       String
  description    String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  areas          Area[]
  inventoryItems Inventory[]   @relation("WarehouseInventory")
  shelves        Shelf[]       @relation("WarehouseShelves")
  transactions   Transaction[] @relation("WarehouseTransactions")
  managers       User[]        @relation("WarehouseManagers")
}

model Area {
  id          String    @id @default(uuid())
  name        String
  description String?
  warehouseId String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])
  shelves     Shelf[]

  @@unique([name, warehouseId])
}

model Shelf {
  id             String      @id @default(uuid())
  name           String
  position       String?
  capacity       Int?
  status         String      @default("Aktif")
  areaId         String
  warehouseId    String
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  inventoryItems Inventory[]
  area           Area        @relation(fields: [areaId], references: [id])
  warehouse      Warehouse   @relation("WarehouseShelves", fields: [warehouseId], references: [id])

  @@unique([name, areaId])
}

model Inventory {
  id          String    @id @default(uuid())
  quantity    Int
  productId   String
  shelfId     String
  warehouseId String
  lastUpdated DateTime  @updatedAt
  product     Product   @relation(fields: [productId], references: [id])
  shelf       Shelf     @relation(fields: [shelfId], references: [id])
  warehouse   Warehouse @relation("WarehouseInventory", fields: [warehouseId], references: [id])

  @@unique([productId, shelfId])
}

model Transaction {
  id          String            @id @default(uuid())
  type        TransactionType
  status      TransactionStatus @default(PENDING)
  date        DateTime          @default(now())
  notes       String?
  createdById String
  warehouseId String
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  createdBy   User              @relation("TransactionCreator", fields: [createdById], references: [id])
  warehouse   Warehouse         @relation("WarehouseTransactions", fields: [warehouseId], references: [id])
  items       TransactionItem[]
}

model TransactionItem {
  id            String        @id @default(uuid())
  transactionId String
  productId     String?
  variantId     String?
  materialId    String?
  quantity      Int
  price         Float
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  product     Product?    @relation(fields: [productId], references: [id], onDelete: SetNull)
  variant     ProductVariantCombination? @relation(fields: [variantId], references: [id], onDelete: SetNull)
  material    Material?   @relation(fields: [materialId], references: [id], onDelete: SetNull)

  @@index([transactionId])
  @@index([productId])
  @@index([variantId])
  @@index([materialId])
}

// Model untuk Supplier
model Supplier {
  id            String   @id @default(uuid())
  name          String
  contactPerson String
  phone         String
  email         String   @unique
  address       String
  status        String   @default("Aktif") // Aktif, Nonaktif
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relasi jika diperlukan, contoh:
  // purchaseOrders PurchaseOrder[]
  // materialPrices MaterialDynamicPrice[]

  @@index([name])
  @@index([email])
}

model Role {
  id          String       @id @default(uuid())
  name        String       @unique
  description String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  userRoles   UserRole[]
  permissions Permission[] @relation("RolePermissions")
}

model Material {
  id             String                 @id @default(uuid())
  name           String
  code           String                 @unique
  unit           String
  initialStock   Int                    @default(0)
  minStockLevel  Int                    @default(0)
  basePrice      Float
  description    String?
  status         MaterialStatus         @default(AKTIF)
  isDynamicPrice Boolean                @default(false)
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt
  imageUrl       String?
  categoryId     String?
  category       Category?              @relation(fields: [categoryId], references: [id])
  dynamicPrices  MaterialDynamicPrice[]
  transactionItems TransactionItem[] // Relasi balik ke TransactionItem
  
  @@index([categoryId])
}

model MaterialDynamicPrice {
  id         String   @id @default(uuid())
  supplier   String
  price      Float
  materialId String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  material   Material @relation(fields: [materialId], references: [id], onDelete: Cascade)

  @@unique([materialId, supplier])
}

model UserRole {
  userId     String
  roleId     String
  assignedAt DateTime @default(now())
  assignedBy String?
  role       Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
}

model Permission {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  roles       Role[]   @relation("RolePermissions")
}

enum TransactionType {
  PURCHASE
  SALE
  TRANSFER
  ADJUSTMENT
}

enum TransactionStatus {
  PENDING
  COMPLETED
  CANCELLED
}

enum MaterialStatus {
  AKTIF
  NONAKTIF
}
