generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id        String   @id @default(uuid())
  name      String
  plan      String   @default("free") // free, basic, premium
  status    String   @default("active") // active, inactive, suspended
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relasi dengan model lain
  users       User[]
  products    Product[]
  warehouses  Warehouse[]
  categories  Category[]
  suppliers   Supplier[]
  materials   Material[]
  roles       Role[]
  transactions Transaction[]
  productCompositions ProductComposition[] // Relation back from ProductComposition
  compositionMaterials CompositionMaterial[] // Relation back from CompositionMaterial
}

model User {
  id           String        @id @default(uuid())
  tenantId     String
  email        String
  name         String
  password     String
  status       String        @default("active") // active, inactive
  lastLogin    DateTime?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  products     Product[]     @relation("ProductCreator")
  transactions Transaction[] @relation("TransactionCreator")
  userRoles    UserRole[]
  warehouses   Warehouse[]   @relation("WarehouseManagers")
  
  tenant       Tenant        @relation(fields: [tenantId], references: [id])
  
  @@unique([email, tenantId]) // Email harus unik dalam satu tenant
  @@index([tenantId])
}

model Product {
  id               String                     @id @default(uuid())
  tenantId         String
  name             String
  description      String?
  sku              String?                    // Optional now, can be generated or set per variant
  price            Float                      // Price for the main product if no variants
  cost             Float?                     // Cost for the main product if no variants
  minStockLevel    Int                        @default(0)
  weight           Float?                     // Weight for the main product if no variants
  weightUnit       String?                    // e.g., 'g', 'kg'
  packageLength    Float?                     // Package dimensions
  packageWidth     Float? 
  packageHeight    Float?
  isPreorder       Boolean                    @default(false)
  preorderDays     Int?
  purchaseLimit    Int?                       // Max quantity per purchase
  hasVariants      Boolean                    @default(false)
  mainImage        String?                    // URL to main product image
  createdAt        DateTime                   @default(now())
  updatedAt        DateTime                   @updatedAt
  createdById      String
  categoryId       String?
  
  inventories      Inventory[]
  category         Category?                  @relation(fields: [categoryId], references: [id])
  createdBy        User                       @relation("ProductCreator", fields: [createdById], references: [id])
  transactionItems TransactionItem[]
  variants         ProductVariant[]           // Relation to product variants
  images           ProductImage[]             // Relation to additional product images
  variantCombos    ProductVariantCombination[] // Relation to variant combinations
  tenant           Tenant                     @relation(fields: [tenantId], references: [id])
  compositions     ProductComposition[]       // Relation back from ProductComposition (one-to-many)

  @@index([tenantId])
  @@index([createdById])
  @@index([categoryId])
}

model ProductVariant {
  id          String                @id @default(uuid())
  name        String                // e.g., "Color", "Size"
  productId   String
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt
  
  product     Product               @relation(fields: [productId], references: [id], onDelete: Cascade)
  options     ProductVariantOption[] // Relation to variant options
}

model ProductVariantOption {
  id          String         @id @default(uuid())
  value       String         // e.g., "Red", "Blue", "S", "M"
  image       String?        // Optional image URL for this option
  variantId   String
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  
  variant     ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
}

model ProductVariantCombination {
  id          String  @id @default(uuid())
  productId   String
  combinationId String // Unique identifier for this combination (e.g., "option1-option2")
  options     Json    // Stored as JSON: { "Color": "Red", "Size": "M" }
  price       Float
  quantity    Int
  sku         String?
  weight      Float?
  weightUnit  String? // e.g., 'g', 'kg'
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  product     Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  @@unique([productId, combinationId])

  transactionItems TransactionItem[] // Relasi balik ke TransactionItem
}

model ProductImage {
  id          String   @id @default(uuid())
  url         String   // URL to the image
  productId   String
  isMain      Boolean  @default(false)
  position    Int      @default(0) // For ordering images
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model Category {
  id          String    @id @default(uuid())
  tenantId    String
  name        String
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  products    Product[]
  materials   Material[]
  tenant      Tenant    @relation(fields: [tenantId], references: [id])
  
  @@unique([name, tenantId]) // Nama kategori harus unik dalam satu tenant
  @@index([tenantId])
}

model Warehouse {
  id             String        @id @default(uuid())
  tenantId       String
  name           String
  location       String
  description    String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  areas          Area[]
  inventoryItems Inventory[]   @relation("WarehouseInventory")
  shelves        Shelf[]       @relation("WarehouseShelves")
  transactions   Transaction[] @relation("WarehouseTransactions")
  managers       User[]        @relation("WarehouseManagers")
  tenant         Tenant        @relation(fields: [tenantId], references: [id])
  
  @@unique([name, tenantId]) // Nama warehouse harus unik dalam satu tenant
  @@index([tenantId])
}

model Area {
  id          String    @id @default(uuid())
  name        String
  description String?
  warehouseId String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])
  shelves     Shelf[]

  @@unique([name, warehouseId])
}

model Shelf {
  id             String      @id @default(uuid())
  name           String
  position       String?
  capacity       Int?
  status         String      @default("Aktif")
  areaId         String
  warehouseId    String
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  inventoryItems Inventory[]
  area           Area        @relation(fields: [areaId], references: [id])
  warehouse      Warehouse   @relation("WarehouseShelves", fields: [warehouseId], references: [id])

  @@unique([name, areaId])
}

model Inventory {
  id          String    @id @default(uuid())
  quantity    Int
  productId   String
  shelfId     String
  warehouseId String
  lastUpdated DateTime  @updatedAt
  product     Product   @relation(fields: [productId], references: [id])
  shelf       Shelf     @relation(fields: [shelfId], references: [id])
  warehouse   Warehouse @relation("WarehouseInventory", fields: [warehouseId], references: [id])

  @@unique([productId, shelfId])
}

model Transaction {
  id          String            @id @default(uuid())
  tenantId    String
  type        TransactionType
  status      TransactionStatus @default(PENDING)
  date        DateTime          @default(now())
  notes       String?
  createdById String
  warehouseId String
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  createdBy   User              @relation("TransactionCreator", fields: [createdById], references: [id])
  warehouse   Warehouse         @relation("WarehouseTransactions", fields: [warehouseId], references: [id])
  items       TransactionItem[]
  tenant      Tenant            @relation(fields: [tenantId], references: [id])
  
  @@index([tenantId])
  @@index([createdById])
  @@index([warehouseId])
}

model TransactionItem {
  id            String        @id @default(uuid())
  transactionId String
  productId     String?
  variantId     String?
  materialId    String?
  quantity      Int
  price         Float
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  product     Product?    @relation(fields: [productId], references: [id], onDelete: SetNull)
  variant     ProductVariantCombination? @relation(fields: [variantId], references: [id], onDelete: SetNull)
  material    Material?   @relation(fields: [materialId], references: [id], onDelete: SetNull)

  @@index([transactionId])
  @@index([productId])
  @@index([variantId])
  @@index([materialId])
}

// Model untuk Supplier
model Supplier {
  id            String   @id @default(uuid())
  tenantId      String
  name          String
  contactPerson String
  phone         String
  email         String
  address       String
  status        String   @default("Aktif") // Aktif, Nonaktif
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  tenant        Tenant   @relation(fields: [tenantId], references: [id])

  // Relasi jika diperlukan, contoh:
  // purchaseOrders PurchaseOrder[]
  // materialPrices MaterialDynamicPrice[]

  @@unique([email, tenantId]) // Email supplier harus unik dalam satu tenant
  @@index([tenantId])
  @@index([name])
}

model Role {
  id          String       @id @default(uuid())
  tenantId    String
  name        String
  description String?
  isDefault   Boolean      @default(false)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  userRoles   UserRole[]
  permissions Permission[] @relation("RolePermissions")
  tenant      Tenant       @relation(fields: [tenantId], references: [id])
  
  @@unique([name, tenantId]) // Nama role harus unik dalam satu tenant
  @@index([tenantId])
}

model Material {
  id             String                 @id @default(uuid())
  tenantId       String
  name           String
  code           String
  unit           String
  initialStock   Int                    @default(0)
  minStockLevel  Int                    @default(0)
  basePrice      Float
  description    String?
  status         MaterialStatus         @default(AKTIF)
  isDynamicPrice Boolean                @default(false)
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt
  imageUrl       String?
  categoryId     String?
  category       Category?              @relation(fields: [categoryId], references: [id])
  dynamicPrices  MaterialDynamicPrice[]
  transactionItems TransactionItem[] // Relasi balik ke TransactionItem
  compositionMaterials CompositionMaterial[] // Relation back from CompositionMaterial
  tenant         Tenant                 @relation(fields: [tenantId], references: [id])
  
  @@unique([code, tenantId]) // Kode material harus unik dalam satu tenant
  @@index([tenantId])
  @@index([categoryId])
}

model MaterialDynamicPrice {
  id         String   @id @default(uuid())
  supplier   String
  price      Float
  materialId String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  material   Material @relation(fields: [materialId], references: [id], onDelete: Cascade)

  @@unique([materialId, supplier])
}

model UserRole {
  userId     String
  roleId     String
  assignedAt DateTime @default(now())
  assignedBy String?
  role       Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
}

model Permission {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  resource    String   // e.g., 'warehouse', 'product', 'user'
  action      String   // 'create', 'read', 'update', 'delete', 'manage'
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  roles       Role[]   @relation("RolePermissions")
}

enum TransactionType {
  PURCHASE
  SALE
  TRANSFER
  ADJUSTMENT
}

enum TransactionStatus {
  PENDING
  COMPLETED
  CANCELLED
}

enum MaterialStatus {
  AKTIF
  NONAKTIF
}

model ProductComposition {
  id           String                @id @default(uuid())
  tenantId     String
  productId    String?               // Null if it's a template
  isTemplate   Boolean               @default(false)
  templateName String?               // Name if it's a template
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt

  tenant       Tenant                @relation(fields: [tenantId], references: [id])
  product      Product?              @relation(fields: [productId], references: [id], onDelete: Cascade)
  materials    CompositionMaterial[] // Relation to materials in this composition

  @@index([tenantId])
  @@index([productId])
}

model CompositionMaterial {
  id              String             @id @default(uuid())
  compositionId   String
  materialId      String
  quantity        Float              // Use Float for potentially fractional quantities
  tenantId        String             // Include tenantId for multi-tenancy consistency
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  composition     ProductComposition @relation(fields: [compositionId], references: [id], onDelete: Cascade)
  material        Material           @relation(fields: [materialId], references: [id]) // Consider onDelete behavior (e.g., Restrict)
  tenant          Tenant             @relation(fields: [tenantId], references: [id])

  @@unique([compositionId, materialId]) // A material should appear only once per composition
  @@index([compositionId])
  @@index([materialId])
  @@index([tenantId])
}