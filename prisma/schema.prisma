generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String        @id @default(uuid())
  email        String        @unique
  name         String
  password     String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  products     Product[]     @relation("ProductCreator")
  transactions Transaction[] @relation("TransactionCreator")
  userRoles    UserRole[]
  warehouses   Warehouse[]   @relation("WarehouseManagers")
}

model Product {
  id               String            @id @default(uuid())
  name             String
  description      String?
  sku              String            @unique
  price            Float
  cost             Float
  minStockLevel    Int               @default(0)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  createdById      String
  categoryId       String?
  inventories      Inventory[]
  category         Category?         @relation(fields: [categoryId], references: [id])
  createdBy        User              @relation("ProductCreator", fields: [createdById], references: [id])
  transactionItems TransactionItem[]
}

model Category {
  id          String    @id @default(uuid())
  name        String    @unique
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  products    Product[]
}

model Warehouse {
  id             String        @id @default(uuid())
  name           String
  location       String
  description    String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  areas          Area[]
  inventoryItems Inventory[]   @relation("WarehouseInventory")
  shelves        Shelf[]       @relation("WarehouseShelves")
  transactions   Transaction[] @relation("WarehouseTransactions")
  managers       User[]        @relation("WarehouseManagers")
}

model Area {
  id          String    @id @default(uuid())
  name        String
  description String?
  warehouseId String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])
  shelves     Shelf[]

  @@unique([name, warehouseId])
}

model Shelf {
  id             String      @id @default(uuid())
  name           String
  position       String?
  capacity       Int?
  status         String      @default("Aktif")
  areaId         String
  warehouseId    String
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  inventoryItems Inventory[]
  area           Area        @relation(fields: [areaId], references: [id])
  warehouse      Warehouse   @relation("WarehouseShelves", fields: [warehouseId], references: [id])

  @@unique([name, areaId])
}

model Inventory {
  id          String    @id @default(uuid())
  quantity    Int
  productId   String
  shelfId     String
  warehouseId String
  lastUpdated DateTime  @updatedAt
  product     Product   @relation(fields: [productId], references: [id])
  shelf       Shelf     @relation(fields: [shelfId], references: [id])
  warehouse   Warehouse @relation("WarehouseInventory", fields: [warehouseId], references: [id])

  @@unique([productId, shelfId])
}

model Transaction {
  id          String            @id @default(uuid())
  type        TransactionType
  status      TransactionStatus @default(PENDING)
  date        DateTime          @default(now())
  notes       String?
  createdById String
  warehouseId String
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  createdBy   User              @relation("TransactionCreator", fields: [createdById], references: [id])
  warehouse   Warehouse         @relation("WarehouseTransactions", fields: [warehouseId], references: [id])
  items       TransactionItem[]
}

model TransactionItem {
  id            String      @id @default(uuid())
  quantity      Int
  price         Float
  productId     String
  transactionId String
  product       Product     @relation(fields: [productId], references: [id])
  transaction   Transaction @relation(fields: [transactionId], references: [id])
}

model Role {
  id          String       @id @default(uuid())
  name        String       @unique
  description String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  userRoles   UserRole[]
  permissions Permission[] @relation("RolePermissions")
}

model Material {
  id             String                 @id @default(uuid())
  name           String
  code           String                 @unique
  unit           String
  initialStock   Int                    @default(0)
  basePrice      Float
  description    String?
  status         MaterialStatus         @default(AKTIF)
  isDynamicPrice Boolean                @default(false)
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt
  imageUrl       String?
  dynamicPrices  MaterialDynamicPrice[]
}

model MaterialDynamicPrice {
  id         String   @id @default(uuid())
  supplier   String
  price      Float
  materialId String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  material   Material @relation(fields: [materialId], references: [id], onDelete: Cascade)

  @@unique([materialId, supplier])
}

model UserRole {
  userId     String
  roleId     String
  assignedAt DateTime @default(now())
  assignedBy String?
  role       Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
}

model Permission {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  roles       Role[]   @relation("RolePermissions")
}

enum TransactionType {
  PURCHASE
  SALE
  TRANSFER
  ADJUSTMENT
}

enum TransactionStatus {
  PENDING
  COMPLETED
  CANCELLED
}

enum MaterialStatus {
  AKTIF
  NONAKTIF
}
